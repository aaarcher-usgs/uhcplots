---
title: "Used-Habitat Calibration Plot Examples"
author: "Althea ArchMiller and John Fieberg"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Introduction 

## UHC Approach

### Example: Missing predictors

In this example, we will assume that the probability of selection is 
proportional to exp(0.5x1 - x2), where x1 is elevation and x2 is 
precipitation. For all scenarios, data were generated under the following
scenario: var(x1) = var(x2) = 4 and the correlation between
x1 and x2, or corr(x1,x2), varies for the training and test data sets. 

Load libraries and set seed
```{r libraries, warning=F,message=F}
library(devtools)
library(KernSmooth)
#install_github("aaarchmiller/uhcplots")
library(uhcplots)
set.seed(1000)
```

Example-specific settings
```{r example1, warning=F,message=F}
# Number of "used" locations
nused_train <- nused_test <- 100 
# Number of "available" or background locations
navail.train <- navail.test <- 10000
# Number of simulated available locations
ntemp <- 1000000
# Number of simulations used to create UHC plot (i.e., "M" from manuscript)
nsims <- 1000
# Example name
example <- "missing predictor"
# Example betas
betas <- c(0.5, -1)
# Labels for x-axes
xlabs <- c("Elevation","Precipitation")
```

### 1a. Scenario where corr(x1,x2) = 0 for both training and test data sets.

Scenario-specific Settings
```{r scenario1}
corx.train <- 0                      
corx.test <- 0                       
scenario <- "corr00"                 
labcor1 <- expression(rho[list(x[1],x[2])]==0)
labcor2 <- expression(rho[list(x[1],x[2])]==0) 
textplot <- ""                       
panlabs1 <- c("A)","B)")     
panlabs2 <- c("A)","B)", "C)", "D)")
top <- 1                           
```

**Simulate Data**

Simulate training data using the uhcdatasimulator() function.
```{r sim1atrain}
traindat <- uhcdatasimulator(nused = nused_train,
                             navail = navail.train,
                             betas = betas,
                             corx = corx.train,
                             ntemp = ntemp,
                             example = example)
```

Simulate test data using the uhcdatasimulator() function.
```{r sim1atest}
testdat <- uhcdatasimulator(nused = nused_test,
                             navail = navail.test,
                             betas = betas,
                             corx = corx.test,
                             ntemp = ntemp,
                             example = example)
```

**Fit GLM Models**

Now, we fit two models, one with both x1 and x2 (i.e., "correct" model) 
and one with just x1 (i.e., "missing predictor" model).

```{r glm1a}
# Correct model
train.correct <- glm(y ~ elev + precip,
                     family = binomial,
                     data = traindat)
# Missing predictor model
train.missingprecip <- glm(y ~ elev,
                           family = binomial,
                           data = traindat)
```

**uhcsim function**

Create simulation envelopes for the environmental characteristic (temperature) 
at the observed locations in the test data using both models (uhcsim function)

```{r uhcsim1}
# Correct model
xhat.correct <- uhcsim(nsims = 1000, 
                       nused_test = nused_test,
                       xmat = testdat[, c("elev","precip")], 
                       fit_rsf = train.correct, 
                       z = testdat[, c("elev","precip")])


# Missing predictor model
xhat.missingprecip <- uhcsim(nsims = nsims, 
                             nused_test = nused_test, 
                             xmat = as.matrix(testdat[, c("elev")]), 
                             fit_rsf = train.missingprecip, 
                             z = testdat[, c("elev","precip")])
```

**uhcdenscalc function**

Calculates kernal density estimates to create UHC plots.

```{r uchdenscalc}
# Correct model
# uhcdenscalc function for both predictors
denshats.elev.correct <- uhcdenscalc(rand_sims = xhat.correct[,,1],
                                  dat = subset(testdat, y==1, select="elev"), 
                                  avail = subset(testdat, y==0, select="elev")) 
denshats.precip.correct <- uhcdenscalc(rand_sims = xhat.correct[,,2], 
                                     dat = subset(testdat, y==1, select="precip"),
                                     avail = subset(testdat, 
                                                  y==0, select="precip")) 

# Missing predictor model
# uhcdenscalc function for both predictors
denshats.elev.missingprecip <- uhcdenscalc(rand_sims = xhat.missingprecip[,,1],
                                           dat = subset(testdat, 
                                                      y==1, select="elev"), 
                                           avail = subset(testdat, 
                                                        y==0, select="elev")) 
denshats.precip.missingprecip <- uhcdenscalc(rand_sims = xhat.missingprecip[,,2], 
                                             dat = subset(testdat, 
                                                        y==1, select="precip"), 
                                             avail = subset(testdat, 
                                                        y==0, select="precip"))
```

### Create UHC plot (formatted for manuscript)

Uses uhcdensplot function

```{r plotuhc00, fig.width=7}
par(mfrow=c(1,5), mar=c(2,2,2,2), oma=c(3, 0, 5, 0), bty="L")

# Use the first plot for text
    plot(1, type="n", xlab="", ylab="", 
         xlim=c(0, 1), ylim=c(0, 1), 
         xaxt='n',yaxt='n',bty='n')
    text(0.01, 0.9, "Training Data", cex=1, adj=0)
    text(0.2, 0.72, labcor1 , cex=1,adj=0) 
    text(0.01, 0.52, "Test Data", cex=1, adj=0)
    text(0.2, 0.40, labcor2 , cex=1, adj=0) 
    legend(0.01, 0.35, c("Available", "Used", "Predicted"), 
            lty = c(1, 2, 1), col = c("black", "red", "grey"), 
            bty = "n", lwd = c(1, 1, 5))

# Incorrect model (missing predictor)
uhcdensplot(densdat = denshats.elev.missingprecip$densdat, 
                densrand = denshats.elev.missingprecip$densrand,
                xl = c(-4,9),
                includeAvail = TRUE,
                densavail = denshats.elev.missingprecip$densavail,
            includeLegend = F) 
    mtext(outer=F, side=2, line=3, "Density", cex=1)
    mtext(side=3, line=1,  panlabs2[1], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[1], cex=1.0)
    
    uhcdensplot(densdat = denshats.precip.missingprecip$densdat, 
            densrand = denshats.precip.missingprecip$densrand,
            xl=c(-9,6),
            includeAvail = TRUE, 
            densavail = denshats.precip.missingprecip$densavail,
            includeLegend = F) 
    mtext(outer=F, side=1, line=4, xlabs[2], cex=1.0)
    mtext(side=3, line=1, panlabs2[2], cex=1, ad=0)

# Correct model (both predictors)
uhcdensplot(densdat = denshats.elev.correct$densdat, 
            densrand = denshats.elev.correct$densrand,
            xl = c(-5,9),
            includeAvail = TRUE, 
            densavail = denshats.elev.correct$densavail,
            includeLegend = F)  
    mtext(side=3, line=1, panlabs2[3], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[1], cex=1.0)

uhcdensplot(densdat = denshats.precip.correct$densdat, 
            densrand = denshats.precip.correct$densrand,
            xl = c(-9,3.5),
            includeAvail = TRUE, 
            densavail = denshats.precip.correct$densavail,
            includeLegend = F) 
    mtext(side=3, line=1, panlabs2[4], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[2], cex=1.0)

    if(top==1){
      mtext(outer=T, side=3.5, line=2, adj=0.80, 
            expression(y %~% elev+precip), cex=1)
      mtext(outer=T, side=3.5, line=2, adj=0.40, 
            expression(y %~% elev), cex=1)
      }
uhc.plot <- recordPlot()
```


#### Optional UHC Plot

Uses uhcdiffdensplot function 

```{r uhcdiff00, fig.width=7}
par(mfrow=c(1,5), mar=c(2,2,2,2), oma=c(3, 0, 5, 0), bty="L")

# Use the first plot for text
plot(1, type="n", xlab="", ylab="", 
     xlim=c(0, 1), ylim=c(0, 1), 
     xaxt='n',yaxt='n',bty='n')
text(0.01, 0.9, "Training Data", cex=1, adj=0)
text(0.2, 0.72, labcor1 , cex=1,adj=0) 
text(0.01, 0.52, "Test Data", cex=1, adj=0)
text(0.2, 0.40, labcor2 , cex=1, adj=0) 

# Incorrect model (missing predictor)
uhcdiffdensplot(densdat = denshats.elev.missingprecip$densdat, 
                densrand = denshats.elev.missingprecip$densrand,
                xl = c(-5,9))  
    mtext(outer=F, side=2, line=3, "Density", cex=1)
    mtext(side=3, line=1,  panlabs2[1], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[1], cex=1)

uhcdiffdensplot(densdat = denshats.precip.missingprecip$densdat, 
                    densrand = denshats.precip.missingprecip$densrand,
                    xl=c(-9,3.5)) 
    mtext(outer=F, side=1, line=4, xlabs[2], cex=1)
    mtext(side=3, line=1, panlabs2[2], cex=1, ad=0)

# Correct model (both predictors)
uhcdiffdensplot(densdat = denshats.elev.correct$densdat, 
                    densrand = denshats.elev.correct$densrand,
                    xl = c(-4,9))  
    mtext(side=3, line=1,  panlabs2[3], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[1], cex=1)

uhcdiffdensplot(densdat = denshats.precip.correct$densdat, 
                    densrand = denshats.precip.correct$densrand,
                    xl = c(-9,6))
    mtext(side=3, line=1,  panlabs2[4], cex=1, ad=0)
    mtext(outer=F, side=1, line=4, xlabs[2], cex=1)

if(top==1){
  mtext(outer=T, side=3.5, line=2, adj=0.80, 
        expression(y %~% elev+precip), cex=1)
  mtext(outer=T, side=3.5, line=2, adj=0.40, 
        expression(y %~% elev), cex=1)
}
```
